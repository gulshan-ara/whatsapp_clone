{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport { getFirebaseApp } from \"../firebaseHelper\";\nimport { createUserWithEmailAndPassword, getAuth, signInWithEmailAndPassword } from \"firebase/auth\";\nimport { child, getDatabase, ref, set, update } from \"firebase/database\";\nimport { authenticate, logOut } from \"../../store/authSlice\";\nimport AsyncStorage from \"@react-native-async-storage/async-storage\";\nimport { getUserData } from \"./userActions\";\nvar timer;\nexport var signUp = function signUp(firstName, lastName, email, password) {\n  return function () {\n    var _ref = _asyncToGenerator(function* (dispatch) {\n      var app = getFirebaseApp();\n      var auth = getAuth();\n      try {\n        var result = yield createUserWithEmailAndPassword(auth, email, password);\n        var _result$user = result.user,\n          uid = _result$user.uid,\n          stsTokenManager = _result$user.stsTokenManager;\n        var accessToken = stsTokenManager.accessToken,\n          expirationTime = stsTokenManager.expirationTime;\n        var expiryDate = new Date(expirationTime);\n        var timeNow = new Date();\n        var miliSecondsUntilExpiry = expiryDate - timeNow;\n        var userData = yield createUser(firstName, lastName, email, uid);\n        dispatch(authenticate({\n          token: accessToken,\n          userData: userData\n        }));\n        saveDataToStorage(accessToken, uid, expiryDate);\n        timer = setTimeout(function () {\n          dispatch(userLogOut());\n        }, miliSecondsUntilExpiry);\n      } catch (error) {\n        console.log(error.message);\n        var errorCode = error.code;\n        var message = \"Something went wrong\";\n        if (errorCode === \"auth/email-already-in-use\") {\n          message = \"This email is already in use\";\n        }\n        throw new Error(message);\n      }\n    });\n    return function (_x) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n};\nvar createUser = function () {\n  var _ref2 = _asyncToGenerator(function* (firstName, lastName, email, userId) {\n    var firstLast = firstName + \" \" + lastName;\n    var userData = {\n      firstName: firstName,\n      lastName: lastName,\n      firstLast: firstLast.toLowerCase(),\n      email: email,\n      userId: userId,\n      signUpDate: new Date().toISOString()\n    };\n    var dbRef = ref(getDatabase());\n    var childRef = child(dbRef, \"user/\" + userId);\n    yield set(childRef, userData);\n    return userData;\n  });\n  return function createUser(_x2, _x3, _x4, _x5) {\n    return _ref2.apply(this, arguments);\n  };\n}();\nvar saveDataToStorage = function saveDataToStorage(token, userId, expiryDate) {\n  AsyncStorage.setItem(\"userData\", JSON.stringify({\n    token: token,\n    userId: userId,\n    expiryDate: expiryDate.toISOString()\n  }));\n};\nexport var signIn = function signIn(email, password) {\n  return function () {\n    var _ref3 = _asyncToGenerator(function* (dispatch) {\n      var app = getFirebaseApp();\n      var auth = getAuth();\n      try {\n        var result = yield signInWithEmailAndPassword(auth, email, password);\n        var _result$user2 = result.user,\n          uid = _result$user2.uid,\n          stsTokenManager = _result$user2.stsTokenManager;\n        var accessToken = stsTokenManager.accessToken,\n          expirationTime = stsTokenManager.expirationTime;\n        var expiryDate = new Date(expirationTime);\n        var timeNow = new Date();\n        var miliSecondsUntilExpiry = expiryDate - timeNow;\n        var userData = yield getUserData(uid);\n        dispatch(authenticate({\n          token: accessToken,\n          userData: userData\n        }));\n        saveDataToStorage(accessToken, uid, expiryDate);\n        timer = setTimeout(function () {\n          dispatch(userLogOut());\n        }, miliSecondsUntilExpiry);\n      } catch (error) {\n        console.log(error.message);\n        var errorCode = error.code;\n        var message = \"Something went wrong\";\n        if (errorCode === \"auth/wrong-password\" || errorCode === \"auth/user-not-found\") {\n          message = \"The username or password is incorrect\";\n        }\n        throw new Error(message);\n      }\n    });\n    return function (_x6) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n};\nexport var userLogOut = function userLogOut() {\n  return function () {\n    var _ref4 = _asyncToGenerator(function* (dispatch) {\n      AsyncStorage.clear();\n      clearTimeout(timer);\n      dispatch(logOut());\n    });\n    return function (_x7) {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n};\nexport var updateSignedInUserDate = function () {\n  var _ref5 = _asyncToGenerator(function* (userId, newData) {\n    if (newData.firstName && newData.lastName) {\n      var firstLast = newData.firstName + \" \" + newData.lastName;\n      newData.firstLast = firstLast.toLowerCase();\n    }\n    var dbRef = ref(getDatabase());\n    var childRef = child(dbRef, \"user/\" + userId);\n    yield update(childRef, newData);\n  });\n  return function updateSignedInUserDate(_x8, _x9) {\n    return _ref5.apply(this, arguments);\n  };\n}();","map":{"version":3,"names":["getFirebaseApp","createUserWithEmailAndPassword","getAuth","signInWithEmailAndPassword","child","getDatabase","ref","set","update","authenticate","logOut","AsyncStorage","getUserData","timer","signUp","firstName","lastName","email","password","_ref","_asyncToGenerator","dispatch","app","auth","result","_result$user","user","uid","stsTokenManager","accessToken","expirationTime","expiryDate","Date","timeNow","miliSecondsUntilExpiry","userData","createUser","token","saveDataToStorage","setTimeout","userLogOut","error","console","log","message","errorCode","code","Error","_x","apply","arguments","_ref2","userId","firstLast","toLowerCase","signUpDate","toISOString","dbRef","childRef","_x2","_x3","_x4","_x5","setItem","JSON","stringify","signIn","_ref3","_result$user2","_x6","_ref4","clear","clearTimeout","_x7","updateSignedInUserDate","_ref5","newData","_x8","_x9"],"sources":["/Users/gulshan/Documents/React_native_dev/whatsapp_clone/utils/actions/authActions.js"],"sourcesContent":["import { getFirebaseApp } from \"../firebaseHelper\";\nimport {\n\tcreateUserWithEmailAndPassword,\n\tgetAuth,\n\tsignInWithEmailAndPassword,\n} from \"firebase/auth\";\nimport { child, getDatabase, ref, set, update } from \"firebase/database\";\nimport { authenticate, logOut } from \"../../store/authSlice\";\nimport AsyncStorage from \"@react-native-async-storage/async-storage\";\nimport { getUserData } from \"./userActions\";\n\nlet timer;\n\nexport const signUp = (firstName, lastName, email, password) => {\n\treturn async (dispatch) => {\n\t\tconst app = getFirebaseApp();\n\t\tconst auth = getAuth();\n\n\t\ttry {\n\t\t\t// creating an user in firebase.\n\t\t\tconst result = await createUserWithEmailAndPassword(\n\t\t\t\tauth,\n\t\t\t\temail,\n\t\t\t\tpassword\n\t\t\t);\n\n\t\t\t// firebase returns an user_id & stsTokenManager\n\t\t\tconst { uid, stsTokenManager } = result.user;\n\n\t\t\t// retrieving the token & it's expiration time from stsTokenManager got from firebase\n\t\t\tconst { accessToken, expirationTime } = stsTokenManager;\n\n\t\t\tconst expiryDate = new Date(expirationTime);\n\t\t\tconst timeNow = new Date();\n\t\t\tconst miliSecondsUntilExpiry = expiryDate - timeNow;\n\n\t\t\tconst userData = await createUser(firstName, lastName, email, uid);\n\n\t\t\t// dispatching the token & user data because authenticate action receives these two as state.\n\t\t\tdispatch(authenticate({ token: accessToken, userData }));\n\n\t\t\t//storing user sign in data to device via async storage\n\t\t\tsaveDataToStorage(accessToken, uid, expiryDate);\n\n\t\t\ttimer = setTimeout(() => {\n\t\t\t\tdispatch(userLogOut());\n\t\t\t}, miliSecondsUntilExpiry);\n\t\t} catch (error) {\n\t\t\tconsole.log(error.message);\n\t\t\tconst errorCode = error.code;\n\n\t\t\tlet message = \"Something went wrong\";\n\n\t\t\tif (errorCode === \"auth/email-already-in-use\") {\n\t\t\t\tmessage = \"This email is already in use\";\n\t\t\t}\n\n\t\t\tthrow new Error(message);\n\t\t}\n\t};\n};\n\nconst createUser = async (firstName, lastName, email, userId) => {\n\tconst firstLast = `${firstName} ${lastName}`;\n\n\tconst userData = {\n\t\tfirstName: firstName,\n\t\tlastName: lastName,\n\t\tfirstLast: firstLast.toLowerCase(),\n\t\temail: email,\n\t\tuserId: userId,\n\t\tsignUpDate: new Date().toISOString(),\n\t};\n\n\tconst dbRef = ref(getDatabase());\n\tconst childRef = child(dbRef, `user/${userId}`);\n\tawait set(childRef, userData);\n\n\treturn userData;\n};\n\nconst saveDataToStorage = (token, userId, expiryDate) => {\n\tAsyncStorage.setItem(\n\t\t\"userData\",\n\t\tJSON.stringify({\n\t\t\ttoken,\n\t\t\tuserId,\n\t\t\texpiryDate: expiryDate.toISOString(),\n\t\t})\n\t);\n};\n\nexport const signIn = (email, password) => {\n\treturn async (dispatch) => {\n\t\tconst app = getFirebaseApp();\n\t\tconst auth = getAuth();\n\n\t\ttry {\n\t\t\tconst result = await signInWithEmailAndPassword(\n\t\t\t\tauth,\n\t\t\t\temail,\n\t\t\t\tpassword\n\t\t\t);\n\t\t\tconst { uid, stsTokenManager } = result.user;\n\t\t\tconst { accessToken, expirationTime } = stsTokenManager;\n\n\t\t\tconst expiryDate = new Date(expirationTime);\n\n\t\t\tconst timeNow = new Date();\n\t\t\tconst miliSecondsUntilExpiry = expiryDate - timeNow;\n\n\t\t\tconst userData = await getUserData(uid);\n\n\t\t\t// redux toolkit code\n\t\t\tdispatch(authenticate({ token: accessToken, userData }));\n\n\t\t\t//storing user sign in data to device via async storage\n\t\t\tsaveDataToStorage(accessToken, uid, expiryDate);\n\n\t\t\ttimer = setTimeout(() => {\n\t\t\t\tdispatch(userLogOut());\n\t\t\t}, miliSecondsUntilExpiry);\n\t\t} catch (error) {\n\t\t\tconsole.log(error.message);\n\t\t\tconst errorCode = error.code;\n\n\t\t\tlet message = \"Something went wrong\";\n\n\t\t\tif (\n\t\t\t\terrorCode === \"auth/wrong-password\" ||\n\t\t\t\terrorCode === \"auth/user-not-found\"\n\t\t\t) {\n\t\t\t\tmessage = \"The username or password is incorrect\";\n\t\t\t}\n\n\t\t\tthrow new Error(message);\n\t\t}\n\t};\n};\n\nexport const userLogOut = () => {\n\treturn async (dispatch) => {\n\t\tAsyncStorage.clear();\n\t\tclearTimeout(timer);\n\t\tdispatch(logOut());\n\t};\n};\n\nexport const updateSignedInUserDate = async (userId, newData) => {\n\tif (newData.firstName && newData.lastName) {\n\t\tconst firstLast = `${newData.firstName} ${newData.lastName}`;\n\t\tnewData.firstLast = firstLast.toLowerCase();\n\t}\n\tconst dbRef = ref(getDatabase());\n\tconst childRef = child(dbRef, `user/${userId}`);\n\tawait update(childRef, newData);\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}